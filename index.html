<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magik RAG</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #202123;
            color: #ccc;
        }
        
        .header {
            padding: 1rem 0;
            color: #ccc;
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 100px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .message-row {
            padding: 1rem;
            width: 100%;
            margin-bottom: 0.5rem;
            color: #ccc;
        }
        
        .user-message .message-content {
            max-width: 80%;
            padding: 1rem;
            border-radius: 1.5rem;
            background-color: #444654;
            margin-left: auto;
            position: relative;
        }
        
        .assistant-message .message-content {
            width: 100%;
            padding: 1rem;
            position: relative;
        }
        
        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            background-color: #202123;
            z-index: 100;
        }
        
        .centered-input-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            max-width: 600px;
            z-index: 100;
        }
        
        .input-box {
            resize: none;
            padding-left: 40px;
            min-height: 80px;
            border-radius: 20px !important;
            color: #ccc !important;
            background-color: #444654 !important;
            border: 2px solid #666 !important;
        }
        
        .input-box:focus {
            box-shadow: none !important;
            border-color: #999 !important;
        }
        
        .input-box::placeholder {
            color: #9aa3b0 !important;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #ccc;
            border-radius: 50%;
            margin: 0 2px;
            opacity: 0.6;
            animation: typing 1.5s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }
        
        pre {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            padding: 1rem;
            overflow-x: auto;
            margin: 1rem 0;
            color: #ccc;
        }
        
        code {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
            color: #ccc;
        }
        
        .settings-icon {
            position: absolute;
            bottom: 17px;
            left: 15px;
            font-size: 1rem;
            cursor: pointer;
            color: #9aa3b0;
            z-index: 1000;
        }
        
        .settings-icon:hover {
            color: #ccc;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-0">
        <header class="text-center header">
            <h3 class="mb-0">Magik RAG</h3>
        </header>
        
        <div class="chat-container" id="chat-container"></div>
        
        <div class="centered-input-container" id="centered-input">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-12">
                        <form id="chat-form">
                            <div class="input-group">
                                <div class="settings-icon" id="settings-button">
                                    <i class="bi bi-gear"></i>
                                </div>
                                <textarea 
                                    class="form-control input-box" 
                                    id="user-input" 
                                    placeholder="Ask me anything" 
                                    rows="4"
                                    autofocus
                                ></textarea>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="input-container hidden" id="bottom-input">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-12 col-md-8 col-lg-6">
                        <form id="bottom-chat-form">
                            <div class="input-group">
                                <div class="settings-icon" id="bottom-settings-button">
                                    <i class="bi bi-gear"></i>
                                </div>
                                <textarea 
                                    class="form-control input-box" 
                                    id="bottom-user-input" 
                                    placeholder="Ask me anything" 
                                    rows="3"
                                    autofocus
                                ></textarea>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Configuration variables
            let meilisearchUrl = localStorage.getItem('meilisearchUrl');
            let apiKey = localStorage.getItem('meilisearchApiKey');
            
            // Conversation state
            let hasStartedConversation = false;
            
            // If not found in localStorage, prompt the user
            if (!meilisearchUrl || !apiKey) {
                promptForCredentials();
            }
            
            function promptForCredentials() {
                meilisearchUrl = prompt("Please enter the Meilisearch URL", meilisearchUrl || "");
                if (!meilisearchUrl) {
                    alert("A Meilisearch URL is required to continue.");
                    promptForCredentials();
                    return;
                }
                
                apiKey = prompt("Please enter your Meilisearch API Key", "");
                if (!apiKey) {
                    alert("An API Key is required to continue.");
                    promptForCredentials();
                    return;
                }
                
                // Save to localStorage
                localStorage.setItem('meilisearchUrl', meilisearchUrl);
                localStorage.setItem('meilisearchApiKey', apiKey);
            }
            
            // DOM Elements
            const chatContainer = document.getElementById('chat-container');
            const centeredInput = document.getElementById('centered-input');
            const bottomInput = document.getElementById('bottom-input');
            
            const chatForm = document.getElementById('chat-form');
            const userInput = document.getElementById('user-input');
            
            const bottomChatForm = document.getElementById('bottom-chat-form');
            const bottomUserInput = document.getElementById('bottom-user-input');
            
            const settingsButton = document.getElementById('settings-button');
            const bottomSettingsButton = document.getElementById('bottom-settings-button');
            
            // Event Listeners
            chatForm.addEventListener('submit', handleSubmit);
            bottomChatForm.addEventListener('submit', handleBottomSubmit);
            
            userInput.addEventListener('input', function() {
                adjustTextareaHeight(userInput);
            });
            
            bottomUserInput.addEventListener('input', function() {
                adjustTextareaHeight(bottomUserInput);
            });
            
            userInput.addEventListener('keydown', function(e) {
                handleKeyDown(e);
            });
            
            bottomUserInput.addEventListener('keydown', function(e) {
                handleKeyDown(e);
            });
            
            settingsButton.addEventListener('click', promptForCredentials);
            bottomSettingsButton.addEventListener('click', promptForCredentials);
            
            // Conversation history
            let conversationHistory = [];
            
            // Auto-resize textarea
            function adjustTextareaHeight(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.max(80, textarea.scrollHeight) + 'px';
            }
            
            // Handle Enter key to submit, Shift+Enter for new line
            function handleKeyDown(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (e.target.value.trim() !== '') {
                        const form = e.target.form;
                        form.dispatchEvent(new Event('submit'));
                    }
                }
            }
            
            // Switch from centered to bottom input
            function switchToBottomInput() {
                if (!hasStartedConversation) {
                    // First transfer the content
                    bottomUserInput.value = userInput.value;
                    
                    // Hide centered input and show bottom input
                    centeredInput.classList.add('hidden');
                    bottomInput.classList.remove('hidden');
                    
                    // Focus the bottom input
                    bottomUserInput.focus();
                    adjustTextareaHeight(bottomUserInput);
                    
                    hasStartedConversation = true;
                }
            }
            
            // Add a message to the chat
            function addMessage(role, content) {
                // If this is the first message, switch to bottom input
                if (!hasStartedConversation) {
                    switchToBottomInput();
                }
                
                const messageRow = document.createElement('div');
                messageRow.className = `message-row ${role === 'user' ? 'user-message' : 'assistant-message'}`;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message-content';
                
                // Simple markdown rendering for code blocks
                let formattedContent = content
                    .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                    .replace(/`([^`]+)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>');
                
                messageDiv.innerHTML = formattedContent;
                
                messageRow.appendChild(messageDiv);
                chatContainer.appendChild(messageRow);
                window.scrollTo(0, document.body.scrollHeight);
                
                // Add to conversation history
                conversationHistory.push({
                    role: role,
                    content: content
                });
            }
            
            // Show loading indicator
            function showLoadingIndicator() {
                const messageRow = document.createElement('div');
                messageRow.className = 'message-row assistant-message';
                messageRow.id = 'loading-indicator';
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message-content';
                
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'd-flex align-items-center';
                
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'typing-dot';
                    typingIndicator.appendChild(dot);
                }
                
                messageDiv.appendChild(typingIndicator);
                
                messageRow.appendChild(messageDiv);
                chatContainer.appendChild(messageRow);
                window.scrollTo(0, document.body.scrollHeight);
            }
            
            // Hide loading indicator
            function hideLoadingIndicator() {
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
            }
            
            // Handle centered form submission
            async function handleSubmit(e) {
                e.preventDefault();
                
                const userMessage = userInput.value.trim();
                if (userMessage === '') return;
                
                // We'll switch to bottom input and show message there
                switchToBottomInput();
                
                // Process the message immediately
                handleMessage(userMessage);
            }
            
            // Handle bottom form submission
            async function handleBottomSubmit(e) {
                e.preventDefault();
                
                const userMessage = bottomUserInput.value.trim();
                if (userMessage === '') return;
                
                handleMessage(userMessage);
            }
            
            // Process user message and get response
            async function handleMessage(userMessage) {
                // Display user message
                addMessage('user', userMessage);
                
                // Clear input
                userInput.value = '';
                bottomUserInput.value = '';
                adjustTextareaHeight(userInput);
                adjustTextareaHeight(bottomUserInput);
                
                // Show loading indicator
                showLoadingIndicator();
                
                // Create a message row for the assistant response
                const messageRow = document.createElement('div');
                messageRow.className = 'message-row assistant-message';
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message-content';
                messageRow.appendChild(messageDiv);
                
                let assistantMessage = '';
                let currentAssistantMessageElement = null;
                
                try {
                    // Prepare the request body following OpenAI API structure
                    const requestBody = {
                        model: "gpt-3.5-turbo", 
                        messages: conversationHistory,
                        temperature: 0.7,
                        max_tokens: 1000,
                        stream: true // Enable streaming
                    };
                    
                    // Make the API call to the /chat endpoint with streaming
                    const response = await fetch(`${meilisearchUrl}/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'Unknown error occurred');
                    }
                    
                    // Get the response as a stream
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    
                    // Hide loading indicator once we start receiving the stream
                    hideLoadingIndicator();
                    
                    // Add the message row to the chat container before streaming
                    chatContainer.appendChild(messageRow);
                    
                    // Process the stream
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        // Decode the chunk
                        const chunk = decoder.decode(value, { stream: true });
                        
                        // Process each line in the chunk
                        const lines = chunk.split('\n').filter(line => line.trim() !== '');
                        for (const line of lines) {
                            // Skip the "data: " prefix and empty lines
                            if (line.startsWith('data: ')) {
                                const data = line.substring(6);
                                
                                // Check if it's the [DONE] message
                                if (data === '[DONE]') continue;
                                
                                try {
                                    const parsedData = JSON.parse(data);
                                    if (parsedData.choices && parsedData.choices.length > 0) {
                                        const content = parsedData.choices[0].delta?.content || '';
                                        if (content) {
                                            assistantMessage += content;
                                            
                                            // Format content with simple markdown
                                            let formattedContent = assistantMessage
                                                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                                                .replace(/`([^`]+)`/g, '<code>$1</code>')
                                                .replace(/\n/g, '<br>');
                                            
                                            messageDiv.innerHTML = formattedContent;
                                            window.scrollTo(0, document.body.scrollHeight);
                                        }
                                    }
                                } catch (e) {
                                    console.error('Error parsing JSON from stream:', e);
                                }
                            }
                        }
                    }
                    
                    // Save the complete message to conversation history
                    conversationHistory.push({
                        role: 'assistant',
                        content: assistantMessage
                    });
                    
                } catch (error) {
                    console.error('Error:', error);
                    
                    // Hide loading indicator
                    hideLoadingIndicator();
                    
                    // Remove the streaming message row if it exists
                    if (messageRow.parentNode) {
                        messageRow.parentNode.removeChild(messageRow);
                    }
                    
                    // Display error message
                    addMessage('assistant', `Error: ${error.message || 'An error occurred while processing your request.'}`);
                }
                
                // Focus the appropriate input box
                if (hasStartedConversation) {
                    bottomUserInput.focus();
                } else {
                    userInput.focus();
                }
            }
            
            // Initialize - focus the input field
            userInput.focus();
        });
    </script>
</body>
</html>